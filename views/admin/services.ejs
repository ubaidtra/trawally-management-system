<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="dashboard-layout">
    <%- include('../partials/sidebar') %>
    
    <div class="main-content">
      <div class="content-header">
        <h1>Service Management</h1>
        <button class="btn btn-primary" onclick="toggleModal('createServiceModal')">Create New Service</button>
      </div>
      
      <% if (error) { %>
        <div class="alert alert-error"><%= error %></div>
      <% } %>
      
      <% if (success) { %>
        <div class="alert alert-success"><%= success %></div>
      <% } %>
      
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Client Name</th>
              <th>Phone</th>
              <th>Service Type</th>
              <th>Service Date</th>
              <th>Status</th>
              <th>Fee</th>
              <th>Deployed Staff</th>
              <th>Transport Cost</th>
              <th>Payment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% services.forEach(service => { %>
              <tr>
                <td><%= service.clientName %></td>
                <td><%= service.clientPhone %></td>
                <td><%= service.serviceType %></td>
                <td><%= new Date(service.serviceDate).toLocaleDateString() %></td>
                <td><span class="badge badge-<%= service.status %>"><%= service.status %></span></td>
                <td>D <%= service.totalFee %></td>
                <td>
                  <% if (service.deployments && service.deployments.length > 0) { %>
                    <span class="badge badge-info"><%= service.deployments.length %> staff</span>
                    <button class="btn btn-sm btn-link" onclick="viewDeployments('<%= service._id %>', 'service')">View</button>
                  <% } else { %>
                    <span class="text-muted">None</span>
                  <% } %>
                </td>
                <td>
                  <% 
                    let totalTransportCost = 0;
                    if (service.deployments && service.deployments.length > 0) {
                      totalTransportCost = service.deployments.reduce((sum, d) => sum + (d.transportationCost || 0), 0);
                    }
                  %>
                  D <%= totalTransportCost.toFixed(2) %>
                </td>
                <td><span class="badge badge-<%= service.paymentStatus %>"><%= service.paymentStatus %></span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="deployStaff('<%= service._id %>', 'service')">Deploy Staff</button>
                  <button class="btn btn-sm btn-secondary" onclick="updateService('<%= service._id %>', '<%= service.status %>', '<%= service.paymentStatus %>')">Update</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="createServiceModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Create New Service</h2>
        <span class="close" onclick="toggleModal('createServiceModal')">&times;</span>
      </div>
      <form action="/admin/services" method="POST">
        <div class="form-grid">
          <div class="form-group">
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" name="clientName" required>
          </div>
          <div class="form-group">
            <label for="clientPhone">Client Phone</label>
            <input type="tel" id="clientPhone" name="clientPhone" required>
          </div>
          <div class="form-group">
            <label for="clientAddress">Client Address</label>
            <input type="text" id="clientAddress" name="clientAddress" required>
          </div>
          <div class="form-group">
            <label for="serviceType">Service Type</label>
            <select id="serviceType" name="serviceType" required>
              <option value="Electrical Installation">Electrical Installation</option>
              <option value="Water Pump Installation">Water Pump Installation</option>
              <option value="Borehole Drilling">Borehole Drilling</option>
              <option value="Water Tank Installation">Water Tank Installation</option>
              <option value="Home Services">Home Services</option>
              <option value="Office Installation">Office Installation</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="serviceDate">Service Date</label>
            <input type="date" id="serviceDate" name="serviceDate" required>
          </div>
          <div class="form-group">
            <label for="totalFee">Total Fee (Dalasi)</label>
            <input type="number" id="totalFee" name="totalFee" required min="0">
          </div>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="3" required></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="toggleModal('createServiceModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Service</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="updateServiceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Update Service</h2>
        <span class="close" onclick="toggleModal('updateServiceModal')">&times;</span>
      </div>
      <form id="updateServiceForm" method="POST">
        <input type="hidden" name="_method" value="PUT">
        <div class="form-group">
          <label for="update_status">Status</label>
          <select id="update_status" name="status" required>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
        <div class="form-group">
          <label for="update_paymentStatus">Payment Status</label>
          <select id="update_paymentStatus" name="paymentStatus" required>
            <option value="unpaid">Unpaid</option>
            <option value="paid">Paid</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="toggleModal('updateServiceModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="deployStaffModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Deploy Staff</h2>
        <span class="close" onclick="toggleModal('deployStaffModal')">&times;</span>
      </div>
      <form id="deployStaffForm" method="POST" action="/deployment" onsubmit="return validateDeploymentForm()">
        <input type="hidden" id="deploy_serviceId" name="serviceId" value="">
        <input type="hidden" id="deploy_contractId" name="contractId" value="" style="display: none;">
        <div class="form-group">
          <label for="deploy_staffId">Staff (Select multiple)</label>
          <select id="deploy_staffId" name="staffId" multiple required style="min-height: 120px;">
            <% staff.forEach(member => { %>
              <option value="<%= member._id %>"><%= member.name %> (<%= member.specialization %>)</option>
            <% }) %>
          </select>
          <small class="form-text">Hold Ctrl/Cmd to select multiple staff members</small>
        </div>
        <div class="form-group">
          <label for="deploy_deploymentDate">Deployment Date</label>
          <input type="date" id="deploy_deploymentDate" name="deploymentDate" required>
        </div>
        <div class="form-group">
          <label for="deploy_transportationMethod">Transportation Method</label>
          <select id="deploy_transportationMethod" name="transportationMethod" required>
            <option value="public-transport">Public Transport</option>
            <option value="personal-vehicle">Personal Vehicle (Fuel)</option>
            <option value="company-vehicle">Company Vehicle (Fuel)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="deploy_transportationCost">Transportation Cost per Staff (Dalasi)</label>
          <input type="number" id="deploy_transportationCost" name="transportationCost" min="0" step="0.01" value="0" required>
          <small class="form-text">This cost will be applied to each selected staff member</small>
        </div>
        <div class="form-group">
          <label for="deploy_notes">Notes (Optional)</label>
          <textarea id="deploy_notes" name="notes" rows="2"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="toggleModal('deployStaffModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Deploy Selected Staff</button>
        </div>
      </form>
    </div>
  </div>

  <div id="viewDeploymentsModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Staff Deployments</h2>
        <span class="close" onclick="toggleModal('viewDeploymentsModal')">&times;</span>
      </div>
      <div id="deploymentsList"></div>
    </div>
  </div>

  <div id="editDeploymentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Deployment</h2>
        <span class="close" onclick="toggleModal('editDeploymentModal')">&times;</span>
      </div>
      <form id="editDeploymentForm" method="POST">
        <input type="hidden" name="_method" value="PUT">
        <div class="form-group">
          <label for="edit_transportationMethod">Transportation Method</label>
          <select id="edit_transportationMethod" name="transportationMethod" required>
            <option value="public-transport">Public Transport</option>
            <option value="personal-vehicle">Personal Vehicle (Fuel)</option>
            <option value="company-vehicle">Company Vehicle (Fuel)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit_transportationCost">Transportation Cost (Dalasi)</label>
          <input type="number" id="edit_transportationCost" name="transportationCost" min="0" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="edit_deploymentStatus">Status</label>
          <select id="edit_deploymentStatus" name="status" required>
            <option value="deployed">Deployed</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit_deploymentNotes">Notes (Optional)</label>
          <textarea id="edit_deploymentNotes" name="notes" rows="2"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="toggleModal('editDeploymentModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Deployment</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    function updateService(id, status, paymentStatus) {
      document.getElementById('updateServiceForm').action = '/admin/services/' + id;
      document.getElementById('update_status').value = status;
      document.getElementById('update_paymentStatus').value = paymentStatus;
      toggleModal('updateServiceModal');
    }

    async function deployStaff(id, type) {
      if (type === 'service') {
        document.getElementById('deploy_serviceId').value = id;
        if (document.getElementById('deploy_contractId')) {
          document.getElementById('deploy_contractId').value = '';
        }
      } else {
        if (document.getElementById('deploy_contractId')) {
          document.getElementById('deploy_contractId').value = id;
        }
        document.getElementById('deploy_serviceId').value = '';
      }
      document.getElementById('deploy_deploymentDate').valueAsDate = new Date();
      const staffSelect = document.getElementById('deploy_staffId');
      Array.from(staffSelect.options).forEach(option => {
        option.selected = false;
        option.disabled = false;
        option.style.color = '';
      });
      document.getElementById('deploy_transportationMethod').value = 'public-transport';
      document.getElementById('deploy_transportationCost').value = '0';
      document.getElementById('deploy_notes').value = '';
      
      try {
        const param = type === 'service' ? `serviceId=${id}` : `contractId=${id}`;
        const response = await fetch(`/deployment/api?${param}`);
        const deployments = await response.json();
        const deployedStaffIds = deployments.map(d => d.staff._id.toString());
        
        Array.from(staffSelect.options).forEach(option => {
          if (deployedStaffIds.includes(option.value)) {
            option.disabled = true;
            option.style.color = '#999';
          } else {
            option.disabled = false;
            option.style.color = '';
          }
        });
      } catch (error) {
        console.error('Error loading existing deployments:', error);
      }
      
      toggleModal('deployStaffModal');
    }

    function validateDeploymentForm() {
      const staffSelect = document.getElementById('deploy_staffId');
      const selectedStaff = Array.from(staffSelect.options).filter(opt => opt.selected && !opt.disabled);
      
      if (selectedStaff.length === 0) {
        alert('Please select at least one staff member');
        return false;
      }
      
      const contractId = document.getElementById('deploy_contractId') ? document.getElementById('deploy_contractId').value : '';
      const serviceId = document.getElementById('deploy_serviceId').value;
      
      if (!contractId && !serviceId) {
        alert('Contract or Service ID is missing');
        return false;
      }
      
      if (contractId && serviceId) {
        alert('Both Contract and Service cannot be set');
        return false;
      }
      
      return true;
    }

    async function viewDeployments(id, type) {
      try {
        const param = type === 'service' ? `serviceId=${id}` : `contractId=${id}`;
        const response = await fetch(`/deployment/api?${param}`);
        const deployments = await response.json();
        
        const transportLabels = {
          'public-transport': 'Public Transport',
          'personal-vehicle': 'Personal Vehicle',
          'company-vehicle': 'Company Vehicle'
        };

        let totalCost = 0;
        let html = '<div class="table-container"><table class="data-table"><thead><tr><th>Staff</th><th>Deployment Date</th><th>Transportation</th><th>Cost</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        
        if (deployments.length === 0) {
          html += '<tr><td colspan="6" class="text-center">No deployments yet</td></tr>';
        } else {
          deployments.forEach(deployment => {
            totalCost += deployment.transportationCost || 0;
            html += `<tr>
              <td>${deployment.staff.name} (${deployment.staff.specialization})</td>
              <td>${new Date(deployment.deploymentDate).toLocaleDateString()}</td>
              <td>${transportLabels[deployment.transportationMethod] || deployment.transportationMethod}</td>
              <td>D ${(deployment.transportationCost || 0).toFixed(2)}</td>
              <td><span class="badge badge-${deployment.status}">${deployment.status.charAt(0).toUpperCase() + deployment.status.slice(1)}</span></td>
              <td>
                <button class="btn btn-sm btn-secondary" onclick="editDeployment('${deployment._id}', '${deployment.transportationMethod}', '${deployment.transportationCost || 0}', '${deployment.status}', '${(deployment.notes || '').replace(/'/g, "\\'")}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteDeployment('${deployment._id}')">Remove</button>
              </td>
            </tr>`;
          });
        }
        
        html += '</tbody></table></div>';
        if (deployments.length > 0) {
          html += `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
            <strong>Total Transportation Cost: D ${totalCost.toFixed(2)}</strong>
          </div>`;
        }
        document.getElementById('deploymentsList').innerHTML = html;
        toggleModal('viewDeploymentsModal');
      } catch (error) {
        console.error('Error loading deployments:', error);
        alert('Error loading deployments');
      }
    }

    function editDeployment(id, transportationMethod, transportationCost, status, notes) {
      document.getElementById('editDeploymentForm').action = '/deployment/' + id;
      document.getElementById('edit_transportationMethod').value = transportationMethod;
      document.getElementById('edit_transportationCost').value = transportationCost;
      document.getElementById('edit_deploymentStatus').value = status;
      document.getElementById('edit_deploymentNotes').value = notes || '';
      toggleModal('editDeploymentModal');
    }

    async function deleteDeployment(id) {
      if (!confirm('Are you sure you want to remove this deployment?')) return;
      
      try {
        const response = await fetch(`/deployment/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            location.reload();
          } else {
            alert(result.error || 'Error removing deployment');
          }
        } else {
          const error = await response.json().catch(() => ({ error: 'Error removing deployment' }));
          alert(error.error || 'Error removing deployment');
        }
      } catch (error) {
        console.error('Error deleting deployment:', error);
        alert('Error removing deployment');
      }
    }
  </script>
</body>
</html>

